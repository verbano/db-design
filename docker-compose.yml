services:
  etcd1:
    image: quay.io/coreos/etcd:v3.5.9
    container_name: etcd1
    hostname: etcd1
    environment:
      - ETCD_NAME=etcd1
      - ETCD_INITIAL_ADVERTISE_PEER_URLS=http://etcd1:2380
      - ETCD_ADVERTISE_CLIENT_URLS=http://etcd1:2379
      - ETCD_LISTEN_PEER_URLS=http://0.0.0.0:2380
      - ETCD_LISTEN_CLIENT_URLS=http://0.0.0.0:2379
      - ETCD_INITIAL_CLUSTER=etcd1=http://etcd1:2380,etcd2=http://etcd2:2380,etcd3=http://etcd3:2380
      - ETCD_INITIAL_CLUSTER_STATE=new
      - ETCD_INITIAL_CLUSTER_TOKEN=pg_etcd_cluster
    volumes:
      - etcd1-data:/var/lib/etcd

  etcd2:
    image: quay.io/coreos/etcd:v3.5.9
    container_name: etcd2
    hostname: etcd2
    environment:
      - ETCD_NAME=etcd2
      - ETCD_INITIAL_ADVERTISE_PEER_URLS=http://etcd2:2380
      - ETCD_ADVERTISE_CLIENT_URLS=http://etcd2:2379
      - ETCD_LISTEN_PEER_URLS=http://0.0.0.0:2380
      - ETCD_LISTEN_CLIENT_URLS=http://0.0.0.0:2379
      - ETCD_INITIAL_CLUSTER=etcd1=http://etcd1:2380,etcd2=http://etcd2:2380,etcd3=http://etcd3:2380
      - ETCD_INITIAL_CLUSTER_STATE=new
      - ETCD_INITIAL_CLUSTER_TOKEN=pg_etcd_cluster
    volumes:
      - etcd2-data:/var/lib/etcd

  etcd3:
    image: quay.io/coreos/etcd:v3.5.9
    container_name: etcd3
    hostname: etcd3
    environment:
      - ETCD_NAME=etcd3
      - ETCD_INITIAL_ADVERTISE_PEER_URLS=http://etcd3:2380
      - ETCD_ADVERTISE_CLIENT_URLS=http://etcd3:2379
      - ETCD_LISTEN_PEER_URLS=http://0.0.0.0:2380
      - ETCD_LISTEN_CLIENT_URLS=http://0.0.0.0:2379
      - ETCD_INITIAL_CLUSTER=etcd1=http://etcd1:2380,etcd2=http://etcd2:2380,etcd3=http://etcd3:2380
      - ETCD_INITIAL_CLUSTER_STATE=new
      - ETCD_INITIAL_CLUSTER_TOKEN=pg_etcd_cluster
    volumes:
      - etcd3-data:/var/lib/etcd

  patroni1:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: patroni1
    hostname: patroni1
    env_file: patroni.env
    depends_on:
      - etcd1
      - etcd2
      - etcd3
    environment:
      - PATRONI_NAME=patroni1
      - PATRONI_RESTAPI_CONNECT_ADDRESS=patroni1:8008
      - PATRONI_POSTGRESQL_CONNECT_ADDRESS=patroni1:5432
    ports:
      - "8008:8008"
    healthcheck:
      test: ["CMD", "patronictl", "list"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

  patroni2:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: patroni2
    hostname: patroni2
    env_file: patroni.env
    depends_on:
      - etcd1
      - etcd2
      - etcd3
      - patroni1
    environment:
      - PATRONI_NAME=patroni2
      - PATRONI_RESTAPI_CONNECT_ADDRESS=patroni2:8008
      - PATRONI_POSTGRESQL_CONNECT_ADDRESS=patroni2:5432
    ports:
      - "8009:8008"

  patroni3:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: patroni3
    hostname: patroni3
    env_file: patroni.env
    depends_on:
      - etcd1
      - etcd2
      - etcd3
      - patroni1
    environment:
      - PATRONI_NAME=patroni3
      - PATRONI_RESTAPI_CONNECT_ADDRESS=patroni3:8008
      - PATRONI_POSTGRESQL_CONNECT_ADDRESS=patroni3:5432
    ports:
      - "8010:8008"

  haproxy:
    image: haproxy:2.4
    container_name: haproxy
    depends_on:
      - patroni2
      - patroni3
    volumes:
      - ./haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD", "haproxy", "-c", "-f", "/usr/local/etc/haproxy/haproxy.cfg"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s

  flyway:
    build: ./flyway
    depends_on:
      haproxy:
        condition: service_healthy
    environment:
      FLYWAY_URL: jdbc:postgresql://haproxy:5432/${DB_NAME}?targetServerType=primary
      FLYWAY_USER: ${MIGRATION_USER}
      FLYWAY_PASSWORD: ${FLYWAY_PASSWORD}
      FLYWAY_BASELINE_ON_MIGRATE: "true"
      FLYWAY_LOCATIONS: filesystem:/flyway/sql
      FLYWAY_TARGET: ${MIGRATION_VERSION:-latest}
      PGPASSWORD: ${POSTGRES_PASSWORD}
      FLYWAY_PLACEHOLDERS_MIGRATION_USER: ${MIGRATION_USER}
      FLYWAY_PLACEHOLDERS_FLYWAY_PASSWORD: ${FLYWAY_PASSWORD}
      FLYWAY_PLACEHOLDERS_DB_NAME: ${DB_NAME}
      FLYWAY_PLACEHOLDERS_ANALYST_NAMES: ${ANALYST_NAMES}
    volumes:
      - ./migrations:/flyway/sql
    env_file:
      - .env

  seeder:
    build: ./seeds
    environment:
      APP_ENV: ${APP_ENV}
      SEED_COUNT: ${SEED_COUNT}
      MIGRATION_VERSION: ${MIGRATION_VERSION:-latest}
      DB_HOST: haproxy
      DB_NAME: ${DB_NAME}
      DB_USER: ${MIGRATION_USER}
      DB_PASSWORD: ${FLYWAY_PASSWORD}
    depends_on:
      flyway:
        condition: service_completed_successfully
    env_file:
      - .env

  load-test:
    build: ./load-test
    environment:
      DB_HOST: haproxy
      DB_PORT: 5432
      DB_NAME: ${DB_NAME} 
      DB_USER: ${POSTGRES_USER}
      DB_PASSWORD: ${POSTGRES_PASSWORD}
    depends_on:
      seeder:
        condition: service_completed_successfully
    ports:
      - "8000:8000"
    env_file:
      - .env

  postgres-exporter:
    image: prometheuscommunity/postgres-exporter
    environment:
      DATA_SOURCE_NAME: "postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@haproxy:5432/${DB_NAME}?sslmode=disable"
    ports:
      - "9187:9187"
    depends_on:
      - haproxy
    env_file:
      - .env

  prometheus:
    image: prom/prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
    depends_on:
      - postgres-exporter
      - load-test
    env_file:
      - .env

  grafana:
    image: grafana/grafana
    ports:
      - "3000:3000"
    environment:
      GF_SECURITY_ADMIN_USER: ${GF_SECURITY_ADMIN_USER}
      GF_SECURITY_ADMIN_PASSWORD: ${GF_SECURITY_ADMIN_PASSWORD}
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/dashboards:/etc/grafana/provisioning/dashboards
      - ./monitoring/datasources:/etc/grafana/provisioning/datasources
    depends_on:
      - prometheus
    env_file:
      - .env

  pg-backup:  
    build: ./backup
    restart: unless-stopped
    depends_on:
      - haproxy
    volumes:
      - ./backups:/backups          
      - /etc/localtime:/etc/localtime:ro  
    environment:
      DB_HOST: haproxy
      DB_NAME: ${DB_NAME}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      BACKUP_RETENTION_COUNT: ${BACKUP_RETENTION_COUNT}
      BACKUP_INTERVAL_CRON: ${BACKUP_INTERVAL_CRON}
    env_file:
      - .env
  test-db:
    image: postgres:13-alpine
    environment:
      POSTGRES_DB: ${TEST_DB_NAME}
      POSTGRES_USER: ${TEST_DB_USER}
      POSTGRES_PASSWORD: ${TEST_DB_PASSWORD}
      PGUSER: ${TEST_DB_USER}
      PGDATABASE: postgres
    healthcheck:
      test: ["CMD-SHELL", "pg_isready"]
      interval: 5s
      timeout: 5s
      retries: 5

  migration-test:
    build: ./migration-test
    environment:
      # PGHOST: ${TEST_DB_HOST}
      POSTGRES_HOST: ${TEST_DB_HOST}
      POSTGRES_DB: ${TEST_DB_NAME}
      POSTGRES_USER: ${TEST_DB_USER}
      POSTGRES_PASSWORD: ${TEST_DB_PASSWORD}
    volumes:
      - ./migrations:/migrations
    depends_on:
      test-db:
        condition: service_healthy

volumes:
  etcd1-data:
  etcd2-data:
  etcd3-data:
  patroni1-data:
  patroni2-data:
  patroni3-data:
  prometheus_data:
  grafana_data: